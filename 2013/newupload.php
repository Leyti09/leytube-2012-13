<?php require($_SERVER['DOCUMENT_ROOT'] . "/static/important/config.inc.php"); ?>
<?php require($_SERVER['DOCUMENT_ROOT'] . "/static/lib/profile.php"); ?>
<!DOCTYPE html>
<html>
<head>
    <title>FulpTube</title>
    <link href="/static/fulptubefull.css" rel="stylesheet">
    <style>
    #myProgress {
        width: 50%;
        background-color: grey;
    }

    #myBar {
        width: 1%;
        height: 10px;
        background-color: green;
    }
    </style>
</head>
<body class="ltr site-left-aligned exp-watch7-comment-ui hitchhiker-enabled guide-enabled guide-expanded page-loaded" dir="ltr">
<div id="body-container">
    <?php require($_SERVER['DOCUMENT_ROOT'] . "/static/important/header.php"); ?>
    <div id="page-container">
        <div id="page" class="  home  clearfix"><div id="guide">        <div id="guide-container" class="">
                    <div id="guide-main" class="    guide-module     spf-nolink ">
                        <div class="guide-module-toggle">
                            <span class="guide-module-toggle-icon">
                              <span class="guide-module-toggle-arrow"></span>
                              <img src="/static/pixel-vfl3z5WfW.gif" alt="">
                              <img src="/static/pixel-vfl3z5WfW.gif" alt="" id="collapsed-notification-icon">
                            </span>
                            <div class="guide-module-toggle-label">
                                <h3>
                                    <span>
                                          Guide
                                    </span>
                                </h3>
                            </div>
                        </div>
                        <div class="guide-module-content yt-scrollbar">
                            <ul class="guide-toplevel">
                                <li id="guide-subscriptions-section" class="guide-section without-filter guide-section-no-counts">
                                    <div id="guide-subs-footer-container">
                                        <div id="guide-subscriptions-container">
                                            <div class="guide-channels-content yt-scrollbar spf-nolink">
                                                <ul id="guide-channels" class="guide-channels-list guide-item-container yt-uix-scroller filter-has-matches">
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  guide-item-selected" href="" title="Popular on YouTube" data-channel-id="HCtnHdj3df7iM" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CEkQgB8oAA">
                                                                  <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/tnHdj3df7iM/default.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/tnHdj3df7iM/default.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                            </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>Popular on FulpTube</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="Music" data-channel-id="HCp-Rdqh3z4Uc" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CEoQgB8oAQ">
                                                                  <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/p-Rdqh3z4Uc/default.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/p-Rdqh3z4Uc/default.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                            </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>Music</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="Sports" data-channel-id="HC7Dr1BKwqctY" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CEsQgB8oAg">
                                                                      <span class="yt-valign-container yt-valign ">
                                                                          <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                      <span class="yt-thumb-square">
                                                                        <span class="yt-thumb-clip">
                                                                          <span class="yt-thumb-clip-inner">
                                                                            <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/7Dr1BKwqctY/default.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/7Dr1BKwqctY/default.jpg" width="18">
                                                                            <span class="vertical-align"></span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                </span>
                                                                        <span class="yt-valign-container display-name">
                                                                          <span>Sports</span>
                                                                        </span>
                                                                      </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="Gaming" data-channel-id="HChfZhJdhTqX8" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CEwQgB8oAw">
                                                                  <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/hfZhJdhTqX8/default.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/hfZhJdhTqX8/default.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                            </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>Gaming</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="Movies" data-channel-id="UCczhp4wznQWonO7Pb8HQ2MQ" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CE0QgB8oBA">
                                                                  <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/czhp4wznQWonO7Pb8HQ2MQ/1.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/czhp4wznQWonO7Pb8HQ2MQ/1.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                            </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>Movies</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="TV Shows" data-channel-id="UCl8dMTqDrJQ0c8y23UBu4kQ" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CE4QgB8oBQ">
                                                                    <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/l8dMTqDrJQ0c8y23UBu4kQ/1.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/l8dMTqDrJQ0c8y23UBu4kQ/1.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                            </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>TV Shows</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="News" data-channel-id="HCPvDBPPFfuaM" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CE8QgB8oBg">
                                                                      <span class="yt-valign-container yt-valign ">
                                                                          <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                      <span class="yt-thumb-square">
                                                                        <span class="yt-thumb-clip">
                                                                          <span class="yt-thumb-clip-inner">
                                                                            <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/PvDBPPFfuaM/default.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/li/PvDBPPFfuaM/default.jpg" width="18">
                                                                            <span class="vertical-align"></span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                </span>
                                                                        <span class="yt-valign-container display-name">
                                                                          <span>News</span>
                                                                        </span>
                                                                      </span>
                                                        </a>
                                                    </li>
                                                    <li class="guide-channel">
                                                        <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="Spotlight" data-channel-id="UCBR8-60-B28hp2BmDPdntcQ" data-sessionlink="feature=g-channel&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CFAQgB8oBw">
                                                                  <span class="yt-valign-container yt-valign ">
                                                                      <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                  <span class="yt-thumb-square">
                                                                    <span class="yt-thumb-clip">
                                                                      <span class="yt-thumb-clip-inner">
                                                                        <img alt="Thumbnail" data-thumb-manual="1" src="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/BR8-60-B28hp2BmDPdntcQ/1.jpg" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/BR8-60-B28hp2BmDPdntcQ/1.jpg" width="18">
                                                                        <span class="vertical-align"></span>
                                                                      </span>
                                                                    </span>
                                                                  </span>
                                                                </span>
                                                                </span>
                                                                    <span class="yt-valign-container display-name">
                                                                      <span>Spotlight</span>
                                                                    </span>
                                                                  </span>
                                                        </a>
                                                    </li>

                                                    <li id="guide-filter-no-results">
                                                        No channels found
                                                    </li>
                                                    <li id="guide-filter-loading-results">
                                                        <p class="yt-spinner">
                                                            <img src="/static/pixel-vfl3z5WfW.gif" class="yt-spinner-img" alt="Loading icon">
                                                            <span class="yt-spinner-message">
                                                                        Loading subscriptions
                                                                    </span>
                                                        </p>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <hr class="guide-section-separator">
                                    </div>
                                </li>
                                <li id="guide-subscription-suggestions-section" class="guide-section guide-section-no-counts">
                                    <h3>
                                        Channels for you
                                    </h3>
                                    <div class="guide-recommendations-list spf-nolink">
                                        <div class="guide-channels-content yt-scrollbar spf-nolink">
                                            <ul class="guide-channels-list guide-item-container yt-uix-scroller filter-has-matches" data-scroller-mousewheel-listener="" data-scroller-scroll-listener="">
                                                <li class="guide-channel">
                                                    <a class="guide-item yt-uix-sessionlink yt-valign  " href="" title="The Ricky Gervais Channel" data-channel-id="UCry7B7DGVgUIa6k4Tis_DJQ" data-sessionlink="feature=g-chrec&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CFIQgB8oAA">
                                                                <span class="yt-valign-container yt-valign ">
                                                                  <span class="thumb">    <span class="video-thumb  yt-thumb yt-thumb-18">
                                                                      <span class="yt-thumb-square">
                                                                        <span class="yt-thumb-clip">
                                                                          <span class="yt-thumb-clip-inner">
                                                                            <img alt="Thumbnail" data-thumb-manual="1" src="" data-thumb="//web.archive.org/web/20130715000613/http://i1.ytimg.com/i/ry7B7DGVgUIa6k4Tis_DJQ/1.jpg" width="18">
                                                                            <span class="vertical-align"></span>
                                                                          </span>
                                                                        </span>
                                                                      </span>
                                                                    </span>
                                                                </span>
                                                                <span class="yt-valign-container display-name">
                                                                  <span>FulpTube</span>
                                                                </span>
                                                              </span>
                                                    </a>
                                                </li>
                                                <li id="guide-filter-no-results">
                                                    No channels found
                                                </li>
                                                <li id="guide-filter-loading-results">
                                                    <p class="yt-spinner">
                                                        <img src="/static/pixel-vfl3z5WfW.gif" class="yt-spinner-img" alt="Loading icon">

                                                        <span class="yt-spinner-message">
                                                                    Loading subscriptions
                                                                </span>
                                                    </p>
                                                </li>
                                            </ul>
                                        </div>

                                    </div>
                                    <hr class="guide-section-separator">
                                    <ul id="gh-management" class="guide-item-container">
                                    <?php require($_SERVER['DOCUMENT_ROOT'] . "/static/important/getsubs.php"); ?>
                                        <li class="guide-channel">
                                            <a class="guide-item yt-uix-sessionlink yt-valign  " href="/channels" title="Browse channels" data-channel-id="guide_builder" data-sessionlink="feature=g-manage&amp;ei=9TzjUbGrIYmZyQHHtICoDg&amp;ved=CFgQhx8oAA">
                                                      <span class="yt-valign-container yt-valign ">
                                                          <span class="thumb guide-management-plus-icon">
                                                            <img src="/static/pixel-vfl3z5WfW.gif" alt="">
                                                          </span>
                                                        <span class="yt-valign-container ">
                                                          <span>Browse channels</span>
                                                        </span>
                                                      </span>
                                            </a>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div id="watch-context-container" class="guide-module collapsed hid"></div>
                </div>
            </div><div id="content" class="">
                <!-- START NEW UPLOAD SYS -->
                <div style="padding: 15px; padding-left: 178px; margin-left: 10px;">
                    <div id="myProgress">
                        <div id="myBar"></div>
                    </div>
                </div>
                <script>
                    var i = 0;
                    function move(perecentage) {
                        var elem = document.getElementById("myBar");
                            elem.style.width = perecentage + "%";
                    } 
                </script>
                <?php
                if($_SERVER['REQUEST_METHOD'] == 'POST') {
                    ini_set('display_errors', 1);
                    ini_set('display_startup_errors', 1);
                    error_reporting(E_ALL);

                    $uploadOk = true;
                    $movedFile = false;

                    $songFileType = strtolower(pathinfo($_FILES["fileToUpload"]["name"], PATHINFO_EXTENSION));
                    $target_name = md5_file($_FILES["fileToUpload"]["tmp_name"]) . "." . $songFileType;

                    $fout = json_decode(shell_exec('ffprobe -v quiet -print_format json -show_format -show_streams "' . $_FILES['fileToUpload']['tmp_name'] . '"'));
                    $w = $fout->streams[0]->width;
                    $h = $fout->streams[0]->height;

                    if(!isset($fout->streams[0]->width)) {
                      $w = $fout->streams[1]->width;
                      $h = $fout->streams[1]->height;
                    }
            
                    if($w > 1300 || $h > 720) {
                        $fileerror = "Video resolution is too big. (Max 1300x720)";
                        $uploadOk = false;
                        goto skip;
                    }

                    // get duration
                    $dur = shell_exec('ffprobe -i ' . $_FILES['fileToUpload']['tmp_name'] . ' -show_entries format=duration -v quiet -of csv="p=0"');
                    $dur = round($dur);

                    if($songFileType != "mp4" && $songFileType != "m4v" && $songFileType != "wmv" && $songFileType != "mkv") {
                        $fileerror = 'unsupported file type. must be mp4<hr>';
                        $uploadOk = false;
                        goto skip;
                    }

                    //what the hell 
                    // for the queue system
                    // this is really dumb but this is the only solution i found!!!
                    $newFile = "/var/phptemp/" . md5_file($_FILES["fileToUpload"]["tmp_name"]) . ".mp4";
                    move_uploaded_file($_FILES['fileToUpload']['tmp_name'], $newFile);

                    if ($uploadOk) {
                        //echo shell_exec("ffmpeg -i " . $_FILES["fileToUpload"]["tmp_name"] . " -vf 'select=eq(n\,34)' -vframes 1 " . $_SERVER['DOCUMENT_ROOT'] . "/dynamic/thumbs/" . md5_file($_FILES["fileToUpload"]["tmp_name"]) . ".png");
                        //echo shell_exec("ffmpeg -i " . $_FILES["fileToUpload"]["tmp_name"] . " -preset ultrafast -threads 4 -s 1280x720 -b:v 750k -c:a copy " . $_SERVER['DOCUMENT_ROOT'] . "/dynamic/videos/" . md5_file($_FILES["fileToUpload"]["tmp_name"]) . ".mp4");

                        //$stmt = $conn->prepare("INSERT INTO videos (title, author, filename, thumbnail, description, tags, rid, duration) VALUES (?, ?, ?, ?, ?, ?, ?, ?)");
                        //$stmt->bind_param("ssssssss", $title, $_SESSION['siteusername'], $filename, $thumbnail, $description, $tags, $rid, $dur);

                        function socketSafeChars($input) {
                          $find = array(';', '\\');
                          $repl = array('\;', '\\\\');  
                          $input = str_replace($find, $repl, $input);
                          return $input;
                        }

                        //$rid = base64_encode(time() . rand(0, 9)) . rand(0, 9) . rand(0, 9);
                        $title = socketSafeChars($_POST['title']);
                        $description = socketSafeChars($_POST['comment']);
                        $tags = socketSafeChars($_POST['tags']);
                        //$filename = md5_file($_FILES["fileToUpload"]["tmp_name"]) . ".mp4";
                        $socketfilename = socketSafeChars($_FILES["fileToUpload"]["tmp_name"]);
                        //$thumbnail = md5_file($_FILES["fileToUpload"]["tmp_name"]) . ".png";
                        $author = socketSafeChars($_SESSION['siteusername']);

                        $string = '/'; 
                        $position = '8'; 
                        $socketfilename = substr_replace( $socketfilename, $string, $position, 0 ); 

                        $buffer = "pushQueue;" . $title . ";" . $description . ";" . $tags . ";" . $newFile . ";" . $author;

                        $fp = fsockopen("localhost", 1024, $errno, $errstr, 30);
                        if (!$fp) {
                            echo "$errstr ($errno)<br />\n";
                        } else {
                            fwrite($fp, $buffer);
                            fclose($fp);
                        }
                        //$stmt->execute();
                        //$stmt->close();

                        echo("Your video is now in a queue. It's now safe to leave this page.");
                    }
                    skip:
                }
                ?>
                <div style="padding: 15px; padding-left: 178px; margin-left: 10px;">
                    <h1>Upload a Video!</h1><br>
                    <?php if(!isset($_SESSION['siteusername'])) { echo("You arent logged in by the way! If you arent logged in, this won't work!"); } ?>
                    <form method="post" enctype="multipart/form-data" id="submitform">
                        <?php if(isset($fileerror)) { echo $fileerror . "<br>"; } ?>
                        <div style="width: 350px; padding: 5px; background-color: whitesmoke;">
                            <b>Title</b> <input type="text" name="title" required="required" row="20"><br>
                            <b>Tags</b> <input type="text" name="tags" required="required" row="20"><br>
                            <input type="file" name="fileToUpload" id="fileToUpload"><br>
                        </div><br>
                        <div style="width: 350px; padding: 5px; background-color: whitesmoke;">
                            <small>
                            Audio is not compressed.<br>
                            Thumbnails are auto generated. <br>
                            All videos are downscaled to 720p@1000kbps by using FFmpeg. <br>
                            MP4, M4V, and MKV are only supported formats.<br>
                            <b>Videos are manually approved</b></small>
                        </div><br>
                        <div style="width: 350px; padding: 5px; background-color: whitesmoke;">
                            <textarea style="width: 345px;" id="com" placeholder="Description" name="comment"></textarea>
                        </div><br>
                        <script src="/js/commd.js"></script>
                        <input type="submit" value="Share your video with the world">
                        <!-- class="g-recaptcha" data-sitekey="<?php // echo $config['recaptcha_sitekey']; ?>" data-callback="onLogin" -->
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-ads">
        <div id="ad_creative_3" class="ad-div " style="z-index: 1">
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
</html>
